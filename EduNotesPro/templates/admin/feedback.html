{% extends "admin/base.html" %}

{% block page_title %}Feedback Management{% endblock %}

{% block content %}
<!-- Feedback Overview -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="stats-card">
            <div class="stats-icon" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                <i class="fas fa-comments"></i>
            </div>
            <div class="stats-number">{{ ratings|length }}</div>
            <div class="stats-label">Total Feedback</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stats-card">
            <div class="stats-icon" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                <i class="fas fa-star"></i>
            </div>
            <div class="stats-number">
                {% if ratings %}
                    {{ "%.1f"|format(ratings|map(attribute='score')|sum / ratings|length) }}
                {% else %}
                    0.0
                {% endif %}
            </div>
            <div class="stats-label">Average Rating</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stats-card">
            <div class="stats-icon" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stats-number">
                {% if ratings %}
                    {{ "%.0f"|format((ratings|selectattr('score', 'ge', 4)|list|length / ratings|length) * 100) }}%
                {% else %}
                    0%
                {% endif %}
            </div>
            <div class="stats-label">Positive (4-5â˜…)</div>
        </div>
    </div>
</div>

<!-- Feedback Table -->
<div class="admin-table">
    <h5 class="table-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-comments me-2"></i>User Feedback with Comments</span>
        <span class="badge bg-light text-dark">{{ ratings|length }} entries</span>
    </h5>
    
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Note</th>
                    <th>User</th>
                    <th>Rating</th>
                    <th>Comment</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for rating in ratings %}
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="file-icon me-3">
                                <i class="fas fa-file-pdf text-danger"></i>
                            </div>
                            <div>
                                <div class="fw-bold">
                                    {% if rating.note %}
                                        {{ rating.note.title[:30] }}{% if rating.note.title|length > 30 %}...{% endif %}
                                    {% else %}
                                        Deleted Note
                                    {% endif %}
                                </div>
                                <small class="text-muted">
                                    {% if rating.note and rating.note.subject %}
                                        {{ rating.note.subject.name }}
                                    {% else %}
                                        Unknown Subject
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="fw-bold">{{ rating.user.username if rating.user else 'Unknown User' }}</div>
                        <small class="text-muted">{{ rating.user.email if rating.user else 'No email' }}</small>
                    </td>
                    <td>
                        <div class="rating-stars">
                            {% for i in range(1, 6) %}
                                <i class="fas fa-star {% if i <= rating.score %}text-warning{% else %}text-muted{% endif %}"></i>
                            {% endfor %}
                        </div>
                        <small class="text-muted">{{ rating.score }}/5</small>
                    </td>
                    <td>
                        <div class="comment-content">
                            {% if rating.comment %}
                                <div class="comment-text">{{ rating.comment }}</div>
                                {% if rating.comment|length > 100 %}
                                <button class="btn btn-link btn-sm p-0 mt-1" onclick="toggleComment(this)">
                                    <small>Show more</small>
                                </button>
                                {% endif %}
                            {% else %}
                                <em class="text-muted">No comment</em>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div>{{ rating.date.strftime('%Y-%m-%d') if rating.date else 'Unknown' }}</div>
                        <small class="text-muted">{{ rating.date.strftime('%H:%M') if rating.date else '' }}</small>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            {% if rating.note %}
                                <a href="{{ url_for('note_detail', note_id=rating.note.id) }}" 
                                   class="btn btn-info btn-sm" title="View Note" target="_blank">
                                    <i class="fas fa-eye"></i>
                                </a>
                            {% endif %}
                            <a href="{{ url_for('delete_feedback', rating_id=rating.id) }}" 
                               class="btn btn-danger btn-sm" title="Delete Feedback"
                               data-confirm="Are you sure you want to delete this feedback?">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center text-muted py-5">
                        <i class="fas fa-comments fa-3x mb-3 text-muted"></i>
                        <div>No feedback with comments found</div>
                        <small>Users haven't left any detailed comments yet</small>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Rating Distribution -->
{% if ratings %}
<div class="row mt-4">
    <div class="col-12">
        <div class="chart-container">
            <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Rating Distribution</h5>
            <canvas id="ratingChart" width="400" height="200"></canvas>
        </div>
    </div>
</div>
{% endif %}

<style>
.file-icon {
    width: 40px;
    height: 40px;
    background: #f8f9fa;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.comment-content {
    max-width: 300px;
}

.comment-text {
    max-height: 60px;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.comment-expanded {
    max-height: none !important;
}

.rating-stars {
    font-size: 1.1rem;
}
</style>
{% endblock %}

{% block extra_scripts %}
{% if ratings %}
<script>
// Rating Distribution Chart
const ctx = document.getElementById('ratingChart').getContext('2d');

// Calculate rating distribution
const ratingCounts = [0, 0, 0, 0, 0]; // For ratings 1-5
{% for rating in ratings %}
ratingCounts[{{ rating.score }} - 1]++;
{% endfor %}

new Chart(ctx, {
    type: 'bar',
    data: {
        labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
        datasets: [{
            label: 'Number of Ratings',
            data: ratingCounts,
            backgroundColor: [
                '#e74c3c',
                '#f39c12',
                '#f1c40f',
                '#2ecc71',
                '#27ae60'
            ],
            borderColor: [
                '#c0392b',
                '#e67e22',
                '#f39c12',
                '#27ae60',
                '#229954'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Toggle comment expansion
function toggleComment(button) {
    const commentText = button.parentElement.querySelector('.comment-text');
    const isExpanded = commentText.classList.contains('comment-expanded');
    
    if (isExpanded) {
        commentText.classList.remove('comment-expanded');
        button.innerHTML = '<small>Show more</small>';
    } else {
        commentText.classList.add('comment-expanded');
        button.innerHTML = '<small>Show less</small>';
    }
}
</script>
{% endif %}
{% endblock %}